define(["jquery","clockpicker"],function(a){var b={polygons:{normal:{},special:{}},colors:{1:{strokeColor:"#4589ef",fillColor:"#71a3ef"},2:{strokeColor:"#1ebd4f",fillColor:"#1ecb54"},3:{strokeColor:"#06954b",fillColor:"#41ad73"},4:{strokeColor:"#9a6a38",fillColor:"#b38f66"},5:{strokeColor:"#6b543c",fillColor:"#917e6a"},6:{strokeColor:"#4589ef",fillColor:"#71a3ef"},7:{strokeColor:"#1ebd4f",fillColor:"#1ecb54"},8:{strokeColor:"#06954b",fillColor:"#41ad73"},9:{strokeColor:"#9a6a38",fillColor:"#b38f66"},10:{strokeColor:"#6b543c",fillColor:"#917e6a"}},areas:{}};return b.init=function(c){if("google"==c.mapType){var d=new google.maps.Map(document.getElementById("allmap"),{center:{lat:parseFloat(c.store.location_x),lng:parseFloat(c.store.location_y)},zoom:14});c.areas.normal&&b.length(c.areas.normal)&&a.each(c.areas.normal,function(a,b){var d=[];for(var e in b.path)d.push({lat:b.path[e].lat?parseFloat(b.path[e].lat):b.path[e][1],lng:b.path[e].lng?parseFloat(b.path[e].lng):b.path[e][0]});c.areas.normal[a].path=d}),c.areas.special&&b.length(c.areas.special)&&a.each(c.areas.special,function(a,b){var d=[];for(var e in b.path)d.push({lat:b.path[e].lat?parseFloat(b.path[e].lat):b.path[e][1],lng:b.path[e].lng?parseFloat(b.path[e].lng):b.path[e][0]});c.areas.special[a].path=d})}else{var d=new AMap.Map("allmap",{resizeEnable:!0,zoom:14,doubleClickZoom:!1,center:[c.store.location_y,c.store.location_x]});d.addControl(new AMap.ToolBar)}window.map=d,window.tmodtpl=c.tmodtpl,b.mapType=c.mapType,b.isChange=c.isChange,b.store=c.store,b.length(c.areas)?(b.length(c.areas.normal)||(c.areas.normal={M1234567891001:{startHour:"00:00",endHour:"00:00",areas:{}}}),b.length(c.areas.special)||(c.areas.special={})):c.areas={normal:{M1234567891001:{startHour:"00:00",endHour:"00:00",areas:{}}},special:{}},b.areas=c.areas,b.areasOriginal=c.areas,b.tplArea(),b.tplEditor(),b.initDom()},b.tplArea=function(){var c=tmodtpl("tpl-area",b);a(".geofence-container").html(c)},b.markerStore=function(){if(b.store.location_y&&b.store.location_x)if("google"==b.mapType)var a=new google.maps.Marker({position:{lat:parseFloat(b.store.location_x),lng:parseFloat(b.store.location_y)},map:map,icon:{url:"../addons/we7_wmall/static/img/shop_marker.png",scaledSize:new google.maps.Size(40,55)}});else{var a=new AMap.Marker({position:[b.store.location_y,b.store.location_x],offset:new AMap.Pixel(-10,-36),content:'<div class="marker-start-head-route"></div>'});a.setMap(map)}},b.tplEditor=function(){if(a(".clockpicker :text").clockpicker({autoclose:!0,afterDone:function(){a(".clockpicker :text").trigger("change"),b.tplArea(),b.tplEditor()}}),"google"==b.mapType){b.markerStore();for(var c in b.polygons)for(var d in b.polygons[c])for(var e in b.polygons[c][d])b.length(b.polygons[c][d][e])&&b.polygons[c][d][e].setVisible(!1);a.each(b.areas,function(c,d){a.each(d,function(d,e){b.polygons[c][d]={},a.each(e.areas,function(a,e){var f=[];for(var g in e.path)f.push({lat:e.path[g].lat?parseFloat(e.path[g].lat):e.path[g][1],lng:e.path[g].lng?parseFloat(e.path[g].lng):e.path[g][0]});var h=b.colors[e.colorType],i=new google.maps.Polygon({paths:f,draggable:!1,editable:!1,fillColor:h.fillColor,fillOpacity:.8,strokeColor:h.strokeColor,strokeOpacity:.9,strokeWeight:3,visible:!0,map:map});b.polygons[c][d][a]=i,i.setMap(map)})})}),a(':hidden[name="areas"]').val(encodeURI(JSON.stringify(b.areas)))}else map.clearMap(),b.markerStore(),a.each(b.areas,function(c,d){a.each(d,function(d,e){b.polygons[c][d]={},a.each(e.areas,function(a,e){var f=b.colors[e.colorType],g=new AMap.Polygon({path:e.path,strokeColor:f.strokeColor,strokeOpacity:.9,strokeWeight:3,fillColor:f.fillColor,fillOpacity:.8});b.polygons[c][d][a]=g,g.setMap(map)})})}),a(':hidden[name="areas"]').val(encodeURI(JSON.stringify(b.areas)))},b.initDom=function(){a('[data-toggle="tooltip"]').tooltip(),a(document).off("click",".area-add"),a(document).on("click",".area-add",function(){var c=a(this).data("type"),d=a(this).data("parentid");if(1==b.isActive)return!1;var e=b.getId("M",0);if(b.length(b.areas[c][d].areas)>=10)return void Notify.info("最多可添加10个！");var f=b.getColor(c,d),g=b.colors[f];if(b.isActive=1,b.areas[c][d].areas[e]={delivery_price:0,delivery_free_price:0,send_price:0,description:"",strokeColor:g.strokeColor,fillColor:g.fillColor,isActive:1,isAdd:1,path:[],colorType:f},b.polygons[c][d]||(b.polygons[c][d]={}),b.polygons[c][d][e]={},"google"==b.mapType){var h=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.POLYGON,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:["polygon","marker","circle","polyline","rectangle"]},polygonOptions:{draggable:!1,editable:!1,fillColor:g.fillColor,fillOpacity:.4,strokeColor:g.strokeColor,strokeOpacity:1,strokeWeight:3,visible:!0,map:map}});h.setMap(map),google.maps.event.addListener(h,"polygoncomplete",function(a){h.setMap(null);for(var f=a.getPath(),g=[],i=0;i<f.getLength();i++){var j=f.getAt(i);g.push({lat:j.lat(),lng:j.lng()})}b.areas[c][d].areas[e].path=g,a.setVisible(!1),b.tplArea(),b.tplEditor()})}else{var i=new AMap.MouseTool(map);i.polygon();AMap.event.addListener(i,"draw",function(a){i.close();var f=a.obj;new AMap.PolyEditor(map,f).open(),b.areas[c][d].areas[e].path=f.getPath(),b.tplArea(),b.tplEditor()})}b.tplArea(),b.tplEditor()}),a(document).off("click",".area-item .editor-area-item"),a(document).on("click",".area-item .editor-area-item",function(){var c=a(this).data("type"),d=a(this).data("parentid"),e=a(this).data("id");if(!(c&&d&&e&&b.polygons[c][d][e]))return!1;b.isActive=1;var f=b.areas[c][d].areas[e];if(f.isActive=1,f.isAdd=0,"google"==b.mapType){var g=b.polygons[c][d][e];g.setEditable(!0)}else{var g=new AMap.PolyEditor(map,b.polygons[c][d][e]);g.open()}b.tplArea()}),a(document).off("click",".area-item .btn-reset"),a(document).on("click",".area-item .btn-reset",function(){var c=a(this).data("type"),d=a(this).data("parentid"),e=a(this).data("id");Notify.confirm("退出编辑后，此次修改将不会生效，是否确定退出？",function(){b.isActive=0;var a=b.areas[c][d].areas[e];a.isActive=0,1==a.isAdd?(delete b.areas[c][d].areas[e],"google"==b.mapType&&(b.polygons[c][d].areas[e].setVisible(!1),delete b.polygons[c][d][e])):(b.areas[c][d].areas[e]=b.areasOriginal[c][d].areas[e],"google"==b.mapType&&(b.polygons[c][d][e].setEditable(!1),b.polygons[c][d][e].setVisible(!1))),b.tplArea(),b.tplEditor()})}),a(document).off("click",".area-item .btn-delete"),a(document).on("click",".area-item .btn-delete",function(){var c=a(this).data("type"),d=a(this).data("parentid"),e=a(this).data("id");Notify.confirm("确定删除此区域吗？",function(){b.isActive=0,delete b.areas[c][d].areas[e],"google"==b.mapType&&(b.polygons[c][d][e].setVisible(!1),delete b.polygons[c][d][e]),b.tplArea(),b.tplEditor()})}),a(document).off("click",".area-item .btn-save"),a(document).on("click",".area-item .btn-save",function(){var c=a(this).data("type"),d=a(this).data("parentid"),e=a(this).data("id");Notify.confirm("确定对该区域进行修改？",function(){var a=b.polygons[c][d][e];if("google"==b.mapType){var f=a.getPath(),g=[];if(f&&f.getLength())for(var h=0;h<f.getLength();h++){var i=f.getAt(h);g.push({lat:i.lat(),lng:i.lng()})}b.areas[c][d].areas[e].path=g,a.setEditable(!1),a.setVisible(!1)}else b.areas[c][d].areas[e].path=a.getPath();if(!b.areas[c][d].areas[e].path.length)return void Notify.info("请设置配送范围！");b.areas[c][d].areas[e].isActive=0,b.isActive=0,b.tplArea(),b.tplEditor()})}),a(document).off("click","#add-hour"),a(document).on("click","#add-hour",function(){var a="special",c=b.getId("M",0);if(1==b.isActive)return!1;var d=b.getId("M",0);if(b.length(b.areas[a])>=10)return void Notify.info("最多可添加10个特殊时段！");var e=b.getColor(a,c),f=b.colors[e];if(b.isActive=1,b.areas[a][c]={startHour:"00:00",endHour:"00:00",areas:{}},b.areas[a][c].areas[d]={delivery_price:0,delivery_free_price:0,send_price:0,description:"",strokeColor:f.strokeColor,fillColor:f.fillColor,isActive:1,isAdd:1,path:[],colorType:e},{}[d]={},b.polygons[a][c]||(b.polygons[a][c]={}),b.polygons[a][c][d]={},"google"==b.mapType){var g=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.POLYGON,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:["polygon","marker","circle","polyline","rectangle"]},polygonOptions:{draggable:!1,editable:!1,fillColor:f.fillColor,fillOpacity:.4,strokeColor:f.strokeColor,strokeOpacity:1,strokeWeight:3,visible:!0,map:map}});g.setMap(map),google.maps.event.addListener(g,"polygoncomplete",function(e){g.setMap(null);for(var f=e.getPath(),h=[],i=0;i<f.getLength();i++){var j=f.getAt(i);h.push({lat:j.lat(),lng:j.lng()})}b.areas[a][c].areas[d].path=h,e.setVisible(!1),b.tplArea(),b.tplEditor()})}else{var h=new AMap.MouseTool(map);h.polygon(),AMap.event.addListener(h,"draw",function(e){h.close();var f=e.obj;new AMap.PolyEditor(map,f).open(),b.areas[a][c].areas[d].path=f.getPath(),b.tplArea(),b.tplEditor()})}b.tplArea(),b.tplEditor()}),a(document).on("input propertychange change",".diy-bind",function(){var c=a(this),d=c.data("bind"),e=c.data("bind-type"),f=c.data("bind-ancestor"),g=c.data("bind-child"),h=c.data("bind-parent"),i="",j=this.tagName;if("INPUT"==j){var k=c.data("placeholder");i=c.val(),i=""==i?k:i}else"SELECT"==j?i=c.find("option:selected").val():"TEXTAREA"==j&&(i=c.val());i=a.trim(i),e?b.areas[e][f][g][h][d]=i:f?b.areas[f][g][h][d]=i:g?b.areas[g][h][d]=i:h?b.areas[h][d]=i:b.areas[d]=i})},b.getColor=function(c,d){var e=[1,2,3,4,5,6,7,8,9,10];if(b.areas[c][d]&&b.areas[c][d].areas)for(var f in b.areas[c][d].areas){var g=a.inArray(b.areas[c][d].areas[f].colorType,e);-1!=g&&e.splice(g,1)}return e.shift()},b.length=function(a){if(void 0===a)return 0;var b=0;for(var c in a)b++;return b},b.getId=function(a,b){return a+(+new Date+b)},b});